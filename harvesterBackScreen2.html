<html>

<head>
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Poppins&display=swap" rel="stylesheet">
    <script src="https://www.google.com/recaptcha/api.js" async defer></script>
</head>

<style>
    .topBar {
        position: absolute;
        width: 405px;
        background: #1e202f;
        height: 25px;
        left: 0px;
        top: 0px;
    }
    
    .resetButton {
        position: absolute;
        top: 550px;
        width: 130px;
        background: transparent;
        height: 27px;
        left: 133px;
        -webkit-app-region: no-drag;
        -webkit-user-select: none;
        font-family: 'Poppins';
        border-radius: 8px;
        border: 1px solid #5DA9FF;
        cursor: pointer;
        color: white;
        transition-property: background;
        transition-duration: 0.4s;
        outline: none;
    }
    
    .resetButton:hover {
        background: #5DA9FF;
    }
    
    .minimize {
        position: absolute;
        width: 24px;
        height: 24px;
        left: 359px;
        -webkit-app-region: no-drag;
        -webkit-user-select: none;
        top: 4px;
        outline: none;
    }
    
    .close {
        position: absolute;
        width: 24px;
        height: 24px;
        left: 380px;
        top: 4px;
        -webkit-app-region: no-drag;
        -webkit-user-select: none;
        outline: none;
    }
</style>

<body>
    <div class="topBar" style="-webkit-app-region: drag">

        <div class="minimize">
            <a href="#" draggable="false" onclick="minimize()">
                <img draggable="false" src="https://i.imgur.com/xGEXoqN.png">
            </a>
        </div>

        <div class="close">
            <a href="#" draggable="false" onclick="closeIt()">
                <img draggable="false" src="https://i.imgur.com/xaIldie.png">
            </a>
        </div>
    </div>
    <button onclick="resetCaptcha()" id="resetButton" style="display:none" class="resetButton">Reset Captcha</button>


    <script>
        const remote = require('electron').remote;
        const app = remote.app
        const ipcRenderer = require('electron').ipcRenderer
        const electron = require('electron');
        const got = require('got');
        const sleep = (waitTimeInMs) => new Promise(resolve => setTimeout(resolve, waitTimeInMs));
        var solving = false
        var search = setInterval(lookforcaptchas, 100)
        async function lookforcaptchas() {
            if (solving == false) {
                let response = await got({
                    method: "get",
                    url: "http://localhost:4444/venetia/viewCaptchaQueue?windowid=" + remote.getCurrentWindow().id,
                    responseType: "json"
                })
                console.log(response.body)
                if (typeof response.body.id != 'undefined') {
                    solving = true
                    clearInterval(search)
                    search = 0
                    remote.getCurrentWindow().focus()
                    if (response.body.taskProxy != "-") {
                        if (Object.keys(response.body.taskProxy).length == 2)
                            remote.getCurrentWindow().getBrowserView(0).webContents.session.setProxy({
                                proxyRules: "https://" + response.body.taskProxy.host + ":" + response.body.taskProxy.port
                            })
                        else if (Object.keys(response.body.taskProxy).length == 3) {
                            var newProxy = response.body.taskProxy.host + ":" + response.body.taskProxy.port
                            ipcRenderer.send('authHarvesterProxy', remote.getCurrentWindow().id, newProxy, response.body.taskProxy.proxyAuth)
                        }
                    } else {
                        remote.getCurrentWindow().getBrowserView(0).webContents.session.setProxy({
                            proxyRules: null
                        })
                    }
                    var d = await remote.getCurrentWindow().getBrowserView(0).webContents.session.cookies.get({
                        url: "https://" + response.body.sessionCookies[0].domain
                    })
                    console.log(d)
                    for (var i = 0; i < d.length; i++) {
                        await remote.getCurrentWindow().getBrowserView(0).webContents.session.cookies.remove("https://" + d[i].domain, d[i].name)
                    }
                    d = await remote.getCurrentWindow().getBrowserView(0).webContents.session.cookies.get({
                        url: "https://" + response.body.sessionCookies[0].domain
                    })
                    for (var i = 0; i < response.body.sessionCookies.length; i++) {
                        await remote.getCurrentWindow().getBrowserView(0).webContents.session.cookies.set({
                            "url": "https://" + response.body.sessionCookies[i].domain,
                            "name": response.body.sessionCookies[i].key,
                            "value": response.body.sessionCookies[i].value,
                            "expirationDate": new Date(response.body.sessionCookies[i].expires).getTime()
                        })
                    }
                    d = await remote.getCurrentWindow().getBrowserView(0).webContents.session.cookies.get({
                        url: "https://" + response.body.sessionCookies[0].domain
                    })

                    await remote.getCurrentWindow().getBrowserView(0).webContents.loadURL(response.body.siteURL, {
                        userAgent: 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.77 Safari/537.36'
                    })

                    document.getElementById("resetButton").style.display = "block"
                    await remote.getCurrentWindow().getBrowserView(0).webContents.executeJavaScript(`
                 var sleep = (waitTimeInMs) => new Promise(resolve => setTimeout(resolve, waitTimeInMs));
                

                if(document.body.parentElement.innerHTML.includes("hcaptcha"))
                    collecthcaptcha()
                else
                    recaptcha()

                 async function recaptcha()
                 {
                  while(await grecaptcha.getResponse() === "")
                    {
                        console.log(await grecaptcha.getResponse())
                        await sleep(100)
                    }
                    var x = {
                        "authToken": document.getElementsByName("authenticity_token")[0].getAttribute("value"),
                        "captchaType": "recaptcha",
                        "captchaResponse": grecaptcha.getResponse()
                    }
     
            
                                   return x
                 }

                    async function collecthcaptcha()
                 {
                    while(await hcaptcha.getResponse() === "")
                    {
                        console.log(await hcaptcha.getResponse())
                        await sleep(100)
                    }
                    var x = {
                        "authToken": document.getElementsByName("authenticity_token")[0].getAttribute("value"),
                        "captchaType": "hcaptcha",
                        "captchaResponse": hcaptcha.getResponse(),
                        "hcaptchachallengeresponsetoken": document.getElementById("hcaptcha_challenge_response_token").value,
                        "hcaptchadata":  document.getElementsByName("hcaptcha_data")[0].value                    }
     
                    return x
                 }

                    `).then(async(ans) => {
                        var y = await remote.getCurrentWindow().getBrowserView(0).webContents.session.cookies.get({
                            url: "https://" + response.body.sessionCookies[0].domain
                        })
                        await got({
                            method: "post",
                            url: "http://localhost:4444/venetia/addToSolvedCaptchas",
                            json: {
                                "id": response.body.id,
                                "captchaResponse": ans,
                                "cookies": y
                            }
                        }).then(() => {
                            remote.getCurrentWindow().getBrowserView(0).webContents.loadFile("harvester.html")
                            solving = false
                            var search = setInterval(lookforcaptchas, 100)
                        })
                    })
                }
            }
        }

        Array.prototype.sample = function() {
            return this[Math.floor(Math.random() * this.length)];
        }

        function resetCaptcha() {
            remote.getCurrentWindow().getBrowserView(0).webContents.loadFile("harvester.html")
            solving = false
            var search = setInterval(lookforcaptchas, 100)
        }

        function minimize() {
            var window2 = remote.getCurrentWindow();
            window2.minimize();
        }

        function closeIt() {
            var x = remote.getCurrentWindow().getBrowserView(0)
            x.webContents.destroy()
            remote.getCurrentWindow().destroy()
        }
    </script>

</body>


</html>