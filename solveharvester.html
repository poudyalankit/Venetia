<html>

<head>
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Poppins&display=swap" rel="stylesheet">
    <script src="https://www.google.com/recaptcha/api.js?render=explicit" async defer></script>
</head>

<style>
    .recaptchaBox {
        position: absolute;
        left: 50px;
        top: 220px;
    }
    
    .topBar {
        position: absolute;
        width: 400px;
        background: #1e202f;
        height: 25px;
        left: 0px;
        top: 0px;
    }
    
    .minimize {
        position: absolute;
        width: 24px;
        height: 24px;
        left: 355px;
        -webkit-app-region: no-drag;
        -webkit-user-select: none;
        top: 4px;
        outline: none;
    }
    
    .resetButton {
        position: absolute;
        top: 370px;
        width: 130px;
        background: transparent;
        height: 27px;
        left: 133px;
        -webkit-app-region: no-drag;
        -webkit-user-select: none;
        font-family: 'Poppins';
        border-radius: 8px;
        border: 1px solid #5DA9FF;
        cursor: pointer;
        color: white;
        transition-property: background;
        transition-duration: 0.4s;
        outline: none;
    }
    
    .resetButton:hover {
        background: #5DA9FF;
    }
    
    .close {
        position: absolute;
        width: 24px;
        height: 24px;
        left: 376px;
        top: 4px;
        -webkit-app-region: no-drag;
        -webkit-user-select: none;
        outline: none;
    }
</style>

<body>
    <div class="harvester">
        <div class="topBar" style="-webkit-app-region: drag">

            <div class="minimize">
                <a href="#" draggable="false" onclick="minimize()">
                    <img draggable="false" src="https://i.imgur.com/xGEXoqN.png">
                </a>
            </div>

            <div class="close">
                <a href="#" draggable="false" onclick="closeIt()">
                    <img draggable="false" src="https://i.imgur.com/xaIldie.png">
                </a>
            </div>
        </div>
        <div class="recaptchaBox" id="displayCaptcha">
            <div id="captchaElement"></div>
        </div>
        <button onclick="reset()" class="resetButton">Reset Captcha</button>

    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>

    <script>
        const remote = require('electron').remote;

        const app = remote.app
        const ipcRenderer = require('electron').ipcRenderer
        const electron = require('electron');
        const got = require('got');
        let captchainfo;

        Array.prototype.sample = function() {
            return this[Math.floor(Math.random() * this.length)];
        }

        window.onload = async(event) => {
            let response = await got.get("http://localhost:4444/venetia/searchByWindowID?windowid=" + remote.getCurrentWindow().id)
            captchaInfo = JSON.parse(response.body)
            console.log(captchaInfo)
            await grecaptcha.render(
                "captchaElement", {
                    "sitekey": captchaInfo.sitekey,
                    "callback": "sub",
                    "theme": "dark"
                }
            )
            remote.getCurrentWindow().focus()
        };

        async function sub() {
            var windowid = await remote.getCurrentWindow().id
            await got.get("http://localhost:4444/venetia/addToSolvedCaptchas?id=" + captchaInfo.id + "&captchaResponse=" + grecaptcha.getResponse())
            await grecaptcha.reset();
            await remote.getCurrentWindow().getBrowserView(0).webContents.loadFile('harvester.html', {
                userAgent: 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/83.0.4103.116 Safari/537.36'
            })
        }

        async function reset() {
            await got.get("http://localhost:4444/venetia/addToSolvedCaptchas?windowid=" + remote.getCurrentWindow().id + "&captchaResponse=none")
            await grecaptcha.reset();
            await remote.getCurrentWindow().getBrowserView(0).webContents.loadFile('harvester.html', {
                userAgent: 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/83.0.4103.116 Safari/537.36'
            })
        }

        function minimize() {
            var window2 = remote.getCurrentWindow();
            window2.minimize();
        }

        function closeIt() {
            var x = remote.getCurrentWindow().getBrowserView(0)
            remote.getCurrentWindow().destroy()
            x.webContents.destroy()
        }
    </script>
</body>

</html>